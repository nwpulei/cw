CW (Morse Code) 高精度自适应解码器：技术方案文档
1. 概述
本文档旨在详细阐述一个高性能、高自适应性的 CW (摩尔斯电码) 解码系统的设计与实现。
该系统旨在解决传统解码方法在面对频率漂移、信号衰落 (QSB)、语速变化和复杂噪声环境时准确率低下的问题。
系统最终采用了一种多层解耦、统计与信号处理相结合的先进架构，其核心思想是：
1.异步频谱监控：使用专业的 Welch 平均周期图法，在后台持续、精准地锁定信号主频。
2.SDR 正交解调：通过 I/Q 解调获取高质量的信号包络，为后续逻辑处理提供干净的输入。
3.动态阈值与增益控制 (AGC)：实时跟踪信号峰值，动态调整触发阈值，有效对抗信号衰落。
4.滑动窗口统计与聚类分析：放弃了容易受干扰的实时移动平均 (EMA) 方法，改为对最近 N 个信号样本进行 K-Means 聚类，从而极度稳健地自适应 5-50 WPM 的宽范围语速。
5.集中化参数配置：将所有关键参数集中到 config.go，实现了易于维护和调优的“白盒”设计。
2. 系统架构系统由以下几个核心模块组成，实现了信号处理、逻辑解码和系统控制的解耦：
•CWSystem (系统主控)：作为顶层协调器，负责初始化和管理音频流、解码器和频谱监控器等所有组件的生命周期。
•SpectrumMonitor (异步频谱监控器)：系统的“频率之眼”。它在独立的 goroutine 中运行，持续对音频进行高精度频谱分析，并将最准确的频率信息反馈给系统。
•SDRDemodulator (SDR 解调器)：系统的“物理层”。负责将指定频率的音频信号从时域转换为干净的信号包络幅度。
•ClusterDecoder (聚类解码器)：系统的“逻辑大脑”。接收包络信号，通过 AGC、滑动窗口统计和 K-Means 聚类算法，自适应地将包络转换为点、划序列，并最终解码为文本。
•Config (配置中心)：系统的“控制面板”。集中管理所有 DSP 参数和阈值，消除了代码中的“魔法数字”，极大地提高了可维护性。
3. 核心模块详解与优化历程
3.1. SpectrumMonitor：高精度频率锁定这是系统最关键的创新点，解决了传统解码器最头疼的频率锁定问题。
•初始问题：
1.低频底噪干扰：简单的 FFT 峰值检测极易被 500Hz 以下的 1/f 噪声或电源哼声干扰，导致初始校准锁定到错误的频率。
2.静音期间“失锁”：在单词间隔等长静音期间，监控器会去追逐随机噪声的峰值，导致频率剧烈跳动。
3.频率抖动：即使锁定到正确频率，由于噪声影响，检测到的频率值也可能在小范围内快速抖动。
•解决方案与演进：
1.【方案】异步 Welch 平均周期图法：我们创建了一个在后台运行的独立线程，它不处理单个 FFT，而是将音频数据分段、加窗、计算功率谱，然后将多段功率谱平均。•
【效果】：极大地平滑了频谱，有效压低了随机噪声，使真实的信号峰值像灯塔一样凸显出来。
2.【方案】频段限制：在 Welch 算法的峰值搜索阶段，强制只搜索 600Hz - 900Hz 的范围。
•【效果】：从物理上完全屏蔽了低频底噪的干扰。
3.【方案】自适应静噪 (Adaptive Squelch)：这是解决“失锁”问题的关键。我们不再使用固定的功率阈值，而是：
•a. 通过对整个功率谱取中位数 (Median) 来稳健地估算噪声基底 (Noise Floor)。
•b. 只有当信号峰值功率超过噪声基底 10 倍 (10dB SNR) 时，才认为检测到了有效信号。
•【效果】：实现了完全自适应的静噪。无论用户音量大小，系统都能准确区分信号和噪声，在静音期间保持频率稳定。
4.【方案】加权平滑更新：为了解决频率抖动，我们引入了带惯性的平滑更新逻辑。
•a. 基于信噪比 (SNR) 动态计算学习率 alpha，SNR 越高，学习率越高。
•b. 使用 smoothedFreq = smoothedFreq * (1 - alpha) + newFreq * alpha 公式进行更新。•
【效果】：频率更新变得像一个有惯性的飞轮，稳定地吸附到真实信号频率上，忽略短暂的干扰。
3.2. ClusterDecoder：自适应时序解码这是系统的另一个核心，解决了语速变化和信号质量不佳导致的解码错误。
•初始问题：
1.点划误判：简单的 EMA（指数移动平均）算法容易被噪声或不规范的发送影响，导致 meanDot 漂移，进而将“划”误判为“点”。
2.字符粘连：在高速 CW 或手键压缩间隔时，字符间隔判定阈值不准，导致多个字符被粘连成一长串无法识别的乱码。
3.信号衰落 (QSB)：固定的触发阈值在信号变弱时会导致“漏码”。
•解决方案与演进：
1.【方案】AGC (自动增益/阈值控制)：•
a. 实时跟踪信号包络的峰值 signalPeak。
•b. signalPeak 会缓慢衰减，以适应信号变弱。
•c. 动态设置施密特触发器阈值：High = signalPeak * 0.5。•
【效果】：使解码器能“跟上”信号强度的变化，在 QSB 环境下依然能稳定触发。
2.【方案】滑动窗口与 K-Means 聚类：这是取代 EMA 的核心升级。
•a. 维护一个存储最近 16 个信号时长 (markBuffer) 和静音时长 (spaceBuffer) 的滑动窗口。
•b. 每当有新数据时，对窗口内的数据进行 K-Means (K=2) 聚类，自动计算出“点”和“划”的中心，以及“元素间隔”和“字符间隔”的中心。
•【效果】：极大地提高了语速估计的稳健性。因为它基于一段时间的统计分布，所以不受单个噪声脉冲或不规范信号的干扰。
3.【方案】WPM 范围限制 (Clamping)：•
a. 虽然 K-Means 很稳健，但仍需防止在极端情况下（如长时间静音后）跑偏。
•b. 我们强制将聚类计算出的 dotLen 限制在 5 WPM (0.24s) 到 50 WPM (0.024s) 的合理范围内。
•【效果】：为自适应算法提供了“安全护栏”，确保其始终在人类可能的发报速度内工作。
4.【方案】Glitch 过滤与硬性兜底：
•a. Glitch Filter：直接忽略所有小于 20ms 的微小信号和静音间隔，视其为噪声或信号抖动。
•b. 硬性兜底：强制规定字符分割阈值不得小于 60ms，以兼容高速 CW。•【效果】：有效解决了信号被切碎和高速 CW 下字符粘连的问题。
4. 总结本系统通过将异步高精度频谱分析与带安全护栏的统计聚类解码相结合，成功构建了一个鲁棒、精准、高自适应性的 CW 解码引擎。它解决了从信号捕获、频率锁定到时序分析的多个核心挑战，为在复杂和多变的真实通信环境中实现可靠解码奠定了坚实的基础。